<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../paper-dialog/paper-action-dialog.html">
<link rel="import" href="../paper-input/paper-input-decorator.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../paper-input/paper-autogrow-textarea.html">
<link rel="import" href="../core-icon/core-icon.html">
<link rel="import" href="../core-pages/core-pages.html">
<link rel="import" href="../paper-tabs/paper-tab.html">
<link rel="import" href="../paper-tabs/paper-tabs.html">
<link rel="import" href="../cg-datetime-picker/cg-datetime-input.html">
<link rel="import" href="../cg-input-tags/cg-input-tags.html">
<link rel="import" href="../cg-input-color/cg-input-color.html">
<link rel="import" href="../cg-input-documents/cg-input-documents.html">

<polymer-element name="cg-event-quickeditor" attributes="event categories colors">
    <template>
        <style>
            :host .colored {
                color: #4285f4;
            }
            :host .range #from {
                padding-right:20px;
            }
            :host paper-action-dialog {
                max-width:450px;
                min-height:500px;
            }
            :host cg-input-documents {
                min-width:350px;
            }
        </style>
        <paper-action-dialog heading="{{heading}}" layered="false" autoCloseDisabled id="dialog">
            <div>
            <paper-tabs selected="{{_selectedPage}}" noink noslide>
                <paper-tab>General</paper-tab>
                <paper-tab>More</paper-tab>
            </paper-tabs>
            <core-pages selected="{{_selectedPage}}">
                <div layout vertical>
                    <paper-input-decorator label="Label" floatingLabel error="{{_validationError}}" autoValidate>
                        <input is="core-input" required value="{{_editCopy.label}}">
                    </paper-input-decorator>
                    <div class="range" layout horizontal>
                        <paper-input-decorator label="From" floatingLabel error="{{_validationError}}" autoValidate id="from">
                            <cg-datetime-input required datetime="{{_editCopy.from}}"></cg-datetime-input>
                        </paper-input-decorator>
                        <paper-input-decorator label="To" floatingLabel error="{{_validationError}}" autoValidate id="to">
                            <cg-datetime-input required datetime="{{_editCopy.to}}"></cg-datetime-input>
                        </paper-input-decorator>
                    </div>
                    <paper-input-decorator label="Notes" floatingLabel>
                        <paper-autogrow-textarea id="notesDec">
                            <textarea value="{{_editCopy.notes}}" id="notes" on-keypress="{{_validate}}"></textarea>
                        </paper-autogrow-textarea>
                    </paper-input-decorator>
                </div>
                <div layout vertical relative>
                    <template if="{{categories.length > 0}}">
                        <paper-input-decorator label="Categories" floatingLabel error="{{_validationError}}" autoValidate>
                            <cg-input-tags tags="{{categories}}" selected="{{_editCopy.categories}}"></cg-input-tags>
                        </paper-input-decorator>
                    </template>
                    <template if="{{colors.length > 0}}">
                        <paper-input-decorator label="Color" floatingLabel error="{{_validationError}}" autoValidate>
                            <cg-input-color required colors="{{colors}}" selected="{{_editCopy.color}}"></cg-input-color>
                        </paper-input-decorator>
                    </template>
                    <cg-input-documents scrolling="false" label="Documents" documents="{{_editCopy.documents}}"></cg-input-documents>
                </div>
            </core-pages>
            </div>
            <paper-button affirmative class="colored custom" on-tap="{{ok}}" id="okButton">
                <core-icon affirmative icon="check"></core-icon>
                <template if="{{ !create }}">ok</template>
                <template if="{{ create }}">add</template>
            </paper-button>
            <paper-button dismissive class="custom" on-tap="{{cancel}}">
                <core-icon dismissive icon="clear"></core-icon>
                cancel
            </paper-button>
            <template if="{{ !create }}">
                <paper-button dismissive class="custom" on-tap="{{delete}}">
                    <core-icon dismissive icon="clear"></core-icon>
                    delete
                </paper-button>
            </template>
        </paper-action-dialog>
    </template>
    <script>
        Polymer("cg-event-quickeditor", {
            event:null,
            heading:"",
            existingEvent:"Edit event",
            addEvent:"Add event",
            create:false,
            categories:[],
            colors:[],
            _selectedPage:0,
            _inputs:null,
            _editCopy:null,
            _validationError:"Invalid or required",
            domReady:function(){
                // TODO : why on-change attribute works on all input but not on cg-datetime-input where it works in other places??
                this._inputs = [].slice.call(this.shadowRoot.querySelectorAll("paper-input-decorator"));
                [].slice.call(this.shadowRoot.querySelectorAll("input,textarea,cg-input-tags")).forEach(function(e){
                    e.addEventListener("change", this._validate.bind(this));
                    e.addEventListener("keydown", this._validate.bind(this));
                    e.addEventListener("cut", this._validate.bind(this));
                    e.addEventListener("paste", this._validate.bind(this));
                    e.addEventListener("blur", this._validate.bind(this));
                    e.addEventListener("focus", this._validate.bind(this));
                }, this);
            },
            _validate:function(e, callback, delay){
                this._doValidate();
                // TODO HACK. Second slightly delayed validation
                // TODO HACK. For some reason when selecting date from button rather than typing it,
                // TODO HACK. change event comes with stale value, see cg-base-input > addEventListener('datetime-changed' and _onInputChange:
                this.job("validate", function(){
                    this._doValidate();
                    callback && callback();
                }.bind(this), delay || 300);
            },
            _doValidate:function(){
                var valid = true;
                this._inputs.forEach(function(e){
                    e.inputAction();
                    if(e.isInvalid) {
                        valid = false;
                    }
                }, this);
                var start = new Date(this._editCopy.from).getTime();
                var end = new Date(this._editCopy.to).getTime();
                if(start >= end) {
                    valid = false;
                    this.$.to.isInvalid = true;
                }
                this.$.okButton.disabled = !valid;
            },
            ok:function(){
                this.event.from = new Date(this._editCopy.from);
                this.event.to = new Date(this._editCopy.to);
                this.event.label = this._editCopy.label;
                this.event.notes = this._editCopy.notes;
                this.event.color = this._editCopy.color;
                this.event.documents = this._editCopy.documents.slice();
                this.event.categories = this._editCopy.categories.slice();
                this.closeDialog("OK");
            },
            cancel:function(){
                this.closeDialog("CANCEL");
            },
            delete:function(){
                this.closeDialog("DELETE");
            },
            _editCopyChanged:function(){
                this.$.notesDec.update(this.$.notes);
            },
            eventChanged:function(){
                this._editCopy = {
                    from:this.event.from ? this.event.from.toISOString() : "",
                    to:this.event.to ? this.event.to.toISOString() : "",
                    label:this.event.label,
                    notes:this.event.notes,
                    color:this.event.color || (this.colors && this.colors.length > 1 ? this.colors[0].mask : ""),
                    categories:this.event.categories?this.event.categories.slice():[],
                    documents:this.event.documents?this.event.documents.slice():[],
                };
            },
            openDialog:function(event, edit){
                this.create = edit === false || event === undefined;
                this.event = event || {};
                this.heading = this.create ? this.addEvent : this.existingEvent;
                this.eventChanged();
                this._validate(null, function(){
                    this.$.dialog.toggle();
                }.bind(this), 10);
            },
            closeDialog:function(result){
                this.$.dialog.open = false;
                this.fire("close", {
                    event: this.event,
                    result: result
                });
            }
        });
    </script>
</polymer-element>