<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../paper-styles/paper-styles.html">
<link rel="import" href="../iron-flex-layout/classes/iron-flex-layout.html">
<link rel="import" href="../paper-material/paper-material.html">
<link rel="import" href="../iron-icon/iron-icon.html">
<link rel="import" href="../cg-base/cg-base-behavior.html">
<link rel="import" href="../cg-pagination/cg-pagination.html">
<link rel="import" href="../cg-link/cg-link.html">
<link rel="import" href="../cg-utils/cg-utils.html">
<link rel="import" href="../font-awesome-polymer-icons/fa-icons.html">

<dom-module is="cg-event-list">
<style>
    :host {
        @apply(--paper-font-body1);
        width:100%;
    }
    .list-wrapper #listScroller {
        min-height:250px;
        z-index: 0;
    }
    .list-wrapper .event-type,
    .list-wrapper .event-duration {
        width:16px;
        height:16px;
        color:#454545;
    }
    .list-wrapper .event-time {
        color:#454545;
        font-size:12px;
    }

    .list-wrapper .event-type,
    .list-wrapper .event-label,
    .list-wrapper .event-time,
    .list-wrapper .event-duration,
    .list-wrapper .event-category {
        margin-right:10px;
        margin-bottom:6px;
    }
    .list-wrapper .event-category {
        color: #454545;
    }

    .list-wrapper .event-category paper-material {
    @apply(--paper-font-caption);
        border-radius:5px;
        line-height: 14px!important;
        padding: 4px;
    }

    .list-wrapper .add-event {
        color: #4285f4;
    }
    .list-wrapper .add-event span {
        margin:5px;
    }

    .list-wrapper .event {
        padding:10px;
    }
    .list-wrapper .event:hover {
        background-color:#dddddd;
    }
    .list-wrapper .event .event-label:hover {
        text-decoration: underline;
        cursor:pointer;
    }
    .list-wrapper .label {
        font-size: 0.75em;
        color:#757575;
        padding-bottom:5px;
    }
    .list-wrapper  .counts {
        margin-top:10px;
    }
    .list-wrapper  .result-count {
        color:#6A6A6A;
        font-size:12px;
        margin:0px 5px;
        text-align: right;
    }

</style>
<template>
    <div class="layout vertical list-wrapper">
        <div hidden$="[[nolabel]]" class="label">[[label]]</div>
        <div id="dialogWrapper"></div>
        <div id="events" class="layout vertical relative">
            <paper-material elevation="1" class="fit"></paper-material>
            <div class="layout horizontal end-justified counts">
                <content select="[action]"></content>
                <span class="result-count">[[_displayCount(events.total)}}</span>
            </div>
            <cg-pagination id="pagination" data="{{events}}" cg-name="[[cgName]]"
                           page-size="[[pageSize]]"
                           pagination-pages="[[paginationPages]]"></cg-pagination>
            <div id="listScroller" hidden$="[[hasLength(events.length]]">
                <template is="dom-repeat" id="list" items="[[events.results]]" class="flex multi layout" sort="sortEvent">
                    <div class="event layout horizontal">
                        <div class="flex layout horizontal wrap">
                            <div class="layout horizontal">
                                <iron-icon class="event-type" icon="fa:calendar-o"></iron-icon>
                                <div class="event-time">
                                    <span>[[_displayTime(item.from)]]</span>
                                    <span>&nbsp;</span>
                                    <span>(</span>
                                    <span>[[_displayDuration(item.from, item.to)]]</span>
                                    <span>)</span>
                                </div>
                            </div>
                            <span class="event-label" on-tap="_onLabelClick">[[item.label]]</span>
                            <cg-link hidden$="[[!hasProp(item.links, showLink)]]" link="[[map(item.links, showLink)]]" linkSource="[[item]]" source="[[self]]"></cg-link>
                            <template is="dom-repeat" items="[[item.categories]]" as="category">
                                <div class="event-category relative">
                                    <paper-material elevation="1"><span>[[category]]</span></paper-material>
                                </div>
                            </template>
                        </div>
                    </div>
                </template>
            </div>
            <div>
                <paper-button id="addbutton" class="add-event" on-tap="_onAddClick">
                    <iron-icon icon="fa:calendar-o"></iron-icon>
                    <span>Add Event</span>
                </paper-button>
            </div>
        </div>
    </div>
</template>
</dom-module>
<script>
    Polymer({
        is:"cg-event-list",
        properties:{
            cgName:{
                type:String,
                value:"events"
            },
            colors:Array,
            categories:Array,
            nolabel:{
                type:Boolean,
                value:false
            },
            label:{
                type:String,
                value:"Events"
            },
            showLink:{
                type:String,
                value:null,
            },
            pageSize:{
                type:Number,
                value:5
            },
            paginationPages:{
                type:Number,
                value:10
            },
            scrolling:{
                type:Boolean,
                value:true
            },
            locale:{
                type:String,
                value:window.navigator.userLanguage || window.navigator.language
            },
            events:Object,
            refreshOnApplicationEvents:{
                type:Array,
                value:[]
            },
            _id:{
                type:Number,
                value:1
            },
            _timeFormat : {
                type:Intl.DateTimeFormat,
                value:function(){
                    return Intl.DateTimeFormat(this.locale, {day:'2-digit', month:'2-digit', year:'numeric', hour:'2-digit', 'minute':'2-digit'})
                }
            }
        },
        behaviors:[CG.BaseBehavior],
        ready:function(){
            this.$.eventEditor = this.globals.eventEditor || this.importHref("./cg-event-editor.html", function(){
                this.$.eventEditor = Polymer.dom(this.$.dialogWrapper).appendChild(this.create("cg-event-editor", {
                    categories:this.categories,
                    colors:this.colors,
                }));
            });
        },
        _displayDuration:function(from, to){
            if(!from || !to) return;
            return CG.Utils.Formats.duration(to.getTime() - from.getTime());
        },
        _displayTime:function(from){
            if(!from) return;
            return this._timeFormat.format(from);
        },
        _displayCount:function(total) {
            return CG.Utils.Displays.countFound("event","events", total);
        },
        sortEvent:function(a,b){
            var at = a.from.getTime();
            var bt = b.from.getTime();
            return at < bt ? 1 : at > bt ? -1 : 0;
        },
        _onAddClick:function(e){
            this.$.eventEditor.openDialog();
        },
        onApplicationEvent:function(type, event){
            switch(type){
                case "event-updated":
                case "event-created":
                case "event-deleted":
                    console.log("[cg-event-list] onApplicationEvent(type:'" + type + "') source is unknown, trigger data refresh");
                    this.reload();
                    return;
            }
            if(this.refreshOnApplicationEvents && this.refreshOnApplicationEvents.indexOf(type) != -1) {
                console.log("[cg-event-list] onApplicationEvent(type:'" + type + "') received, trigger data refresh");
                this.reload();
            }
        },
        contextChanged:function(){
            this.reload();
        },
        reload:function(){
            this.$.pagination.reload();
        },
        _onLabelClick:function(e){
            this.$.eventEditor.openDialog(e.model.item, undefined, this);
        },
    });
</script>