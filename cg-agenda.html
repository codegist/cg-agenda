<link href="../polymer/polymer.html" rel="import">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../font-awesome-polymer-icons/fa-icons.html">

<polymer-element name="cg-agenda">
    <template>
        <style>
            .noselect {
                -webkit-touch-callout: none;
                -webkit-user-select: none;
                -khtml-user-select: none;
                -moz-user-select: none;
                -ms-user-select: none;
                user-select: none;
            }
            :host  {
                width: 100%;
            }
            :host .weekday,
            :host .agengaday {
                border-left:1px solid #ccc;
                text-align: center;
            }
            :host .weekday,
            :host .agengaday {
                margin:0 5px 0 5px;
            }
            :host .agengaday {
                height:{{hourHeight * 24}}px;
            }
            :host .event {
                background-color:#008800;
                position:absolute;
                border:1px solid white;
                border-radius: 5px;
                cursor: pointer;
            }
            :host .event .header {
                font-weight: bold;
                font-size: 12px;
                color: white;
                text-align: left;
                margin-left: 3px;
            }
        </style>
        <div id="agenda" layout vertical flex>
            <paper-button on-tap="{{toggleCache}}">toggle cache</paper-button>
            <paper-button on-tap="{{redrawAll}}">redraw all</paper-button>
            <div class="weekdays noselect" layout horizontal >
                <template repeat="{{_weekDays as day}}">
                    <div flex class="weekday noselect" data-value="{{day.day}}">{{day.name}} {{day.day}}</div>
                </template>
            </div>
            <div class="agendadays noselect" layout horizontal id="agendadays">
                <template repeat="{{_weekDays as day}}">
                    <div flex class="agengaday noselect" data-day="{{day.day}}" data-month="{{day.month}}" data-year="{{day.year}}" on-mouseover="{{onDayOver}}" relative>
                        <template repeat="{{_events as e}}">
                            <template if="{{isEventOfDay(e, day, e.redraw)}}">
                                <div class="event noselect"
                                     style="{{calcEventStyle(e, e.redraw)}}"
                                     data-id="{{e.id}}"
                                     on-trackstart="{{onEventTrackStart}}"
                                     on-track="{{onEventTrack}}"
                                     on-trackend="{{onEventTrackEnd}}"
                                    >
                                    <div class="header noselect">{{eventRangeDisplay(e, e.redraw)}}</div>
                                </div>
                            </template>
                        </template>
                    </div>
                </template>
            </div>
        </div>

    </template>
    <script>
        (function(){
            var CalendarHelper = {
                cache:true,
                _collisionGroupCache:{
                    id:0
                },
                between: function(events, date1, date2){
                    var between = [];



                    return between;
                },
                intersects: function(e1, e2){
                    var s1 = e1.from.getTime();
                    var e1 = e1.to.getTime();
                    var s2 = e2.from.getTime();
                    var e2 = e2.to.getTime();
                    return (s1 < s2 && e1 > s2) || (s1 >= s2 && (e1 < e2 || (s1 < e2))) || s1 <= s2 && e1 >= e2;
                },
                orderEvents:function(events, copy){
                    events = copy === false ? events : events.slice();
                    events.sort(this.eventComparator);
                    return events;
                },
                eventComparator:function(a,b){
                    var aFrom = a.from.getTime();
                    var bFrom = b.from.getTime();
                    var aTo = a.to.getTime();
                    var bTo = b.to.getTime();
                    return  aFrom < bFrom ? -1 : aFrom > bFrom ? 1 : aTo < bTo ? 1 : aTo > bTo ? -1 : 0;
                },
                primeCache:function(events, from, to){
                    events.forEach(function(e){
                        if(this.intersects({
                                    from:from,
                                    to:to
                                }, e) && e.collisionGroupId === undefined) {
                            this.findCollisionGroups(events, e, false);
                        }
                    }.bind(this));
                },
                findCollisionGroups:function(events, event, order, invalidateCache){
                    if(this.cache == false) {
                        return this.getCollisionGroups(events, event, order);
                    }
                    if(invalidateCache) {
                        console.log("invalidateCache")
                        var oldGroup = this._collisionGroupCache[event.collisionGroupId];
                        if(oldGroup) {
                            for(var i = 0; i < oldGroup.length; i++){
                                var indexOf = oldGroup[i].indexOf(event);
                                if(indexOf != -1) {
                                    console.log("removed from cached group")
                                    oldGroup[i].splice(indexOf, 1);
                                    break;
                                }
                            }
                        }
                        delete event.collisionGroupId;
                    }
                    var collisionGroup = this._collisionGroupCache[event.collisionGroupId];
                    if(!collisionGroup) {
                        console.log("refreshing cache")
                        collisionGroup = this.getCollisionGroups(events, event, order);
                        var collisionGroupId = this._collisionGroupCache.id++;
                        for(var groupIndex = 0; groupIndex < collisionGroup.length; groupIndex++){
                            var group = collisionGroup[groupIndex];
                            for(var eventIndex = 0; eventIndex < group.length; eventIndex++){
                                group[eventIndex].collisionGroupId = collisionGroupId;
                                event.collisionGroupId = collisionGroupId;
                            }
                        }
                        this._collisionGroupCache[collisionGroupId] = collisionGroup;
                    }else{
                        console.log("cache hit")
                    }
                    collisionGroup = collisionGroup.slice();
                    for(var i = 0; i < collisionGroup.length; i++){
                        collisionGroup[i] = collisionGroup[i].slice();
                    }
                    return collisionGroup.slice();
                },
                getCollisionGroups:function(events, event, order){
                    if(events.length == 0) {
                        return [];
                    }
                    events = order === false ? events.slice() : this.orderEvents(events);
                    var groups = [];

                    groups.push(events.splice(event ? events.indexOf(event) : 0, 1));

                    var c = 0;
                    while(events.length > 0){
                        var found = false;
                        var e = events[c];
                        out: for(var i = 0; i < groups.length; i++){
                            var group = groups[i];
                            for(var j = 0; j < group.length; j++){
                                if(this.intersects(e, group[j])){
                                    group.push(e);
                                    found = true;
                                    break out;
                                }
                            }
                        }
                        if(!found) {
                            if(event) {
                                c++;
                                if(c == events.length) {
                                    events.splice(0, 1);
                                    c = 0;
                                }
                                continue;
                            }else{
                                events.splice(0, 1);
                                groups.push([e]);
                            }
                        }else{
                            events.splice(c, 1);
                            c = 0;
                        }
                    }
                    if(event) {
                        this.orderEvents(groups[0], false);
                    }
                    return groups;
                },
                getCollisionFreeMatrix:function(collisionGroup, copy){
                    collisionGroup = copy === false ? collisionGroup : collisionGroup.slice();
                    var matrix = [collisionGroup.splice(0,1)];
                    var columnIndex = 0;
                    while(collisionGroup.length > 0){
                        var column = matrix[columnIndex];
                        var b = collisionGroup[0];
                        var found = false;
                        for(var c = 0; c < column.length; c++){
                            if(this.intersects(column[c], b)) {
                                found = true;
                                break;
                            }
                        }
                        if(!found) {
                            column.push(b);
                            collisionGroup.splice(0, 1);
                            columnIndex = 0;
                        }else{
                            columnIndex++;
                            if(columnIndex == matrix.length) {
                                matrix.push([b]);
                                collisionGroup.splice(0, 1);
                                columnIndex = 0;
                            }
                        }
                    }
                    return matrix;
                },
                findCollisionGroupsForSingleEvent:function(events, event, order, invalidateCache){
                    return this.findCollisionGroups(events, event, order, invalidateCache)[0];
                },
                findCollisionMatrixInfoForSingleEvent:function(events, event, order, invalidateCache){
                    var groups = this.findCollisionGroups(events, event, order, invalidateCache);
                    var matrix = this.getCollisionFreeMatrix(groups[0], false);
                    var columnIndex = 0;
                    var totalColumns = matrix.length;
                    out: for(; columnIndex < matrix.length; columnIndex++){
                        var column = matrix[columnIndex];
                        for(var i=0; i < column.length; i++){
                            if(column[i] == event) {
                                break out;
                            }
                        }
                    }
                    return {
                        column:columnIndex + 1,
                        totalColumns:totalColumns
                    };
                },
                shuffle:function(o){
                    for(var j, x, i = o.length; i; j = Math.floor(Math.random() * i), x = o[--i], o[i] = o[j], o[j] = x);
                    return o;
                }
            };

            Polymer("cg-agenda", {
                startDayOfWeek:1,
                hourHeight:40,
                dragMinuteStep:15,
                _viewFrom:null,
                _viewTo:null,
                _weekDays:[],
                _events:[],
                _initialDragInfos:null,
                _timeFormat : Intl.DateTimeFormat(this.locale, {hour:'2-digit', minute:'2-digit', hour12:false}),
                toggleCache:function(){
                    CalendarHelper.cache = !CalendarHelper.cache;
                    this.redrawAll();
                },
                set events(events){
                    CalendarHelper.orderEvents(events, false);
                    console.log("priming cache")
                    CalendarHelper.primeCache(events, this._viewFrom, this._viewTo);
                    console.log("priming cache done")
                    events.forEach(function(e){
                        e.redraw = true;
                    });
                    this._events = events;
                },
                get events(){
                    return this._events;
                },
                onDayOver:function(e){
                    this._dayOver = {
                        day: Number(e.currentTarget.dataset.day),
                        month: Number(e.currentTarget.dataset.month),
                        year: Number(e.currentTarget.dataset.year)
                    };
                },
                eventRangeDisplay:function(e){
                    var from = this._timeFormat.format(e.dragging ? e.dragging.from : e.from);
                    var to = this._timeFormat.format(e.dragging ? e.dragging.to : e.to);
                    return e.id;
//                    return from + " - " + to;
                },
                _getEventById:function(id) {
                    for(var i = 0; i < this._events.length; i++){
                        if(id == this._events[i].id) {
                            return this._events[i];
                        }
                    }
                    return null;
                },
                onEventTrackStart:function(e){
                    var event = this._getEventById(e.currentTarget.dataset.id);
                    this._initialDragInfos = {
                        event:event,
                        mouseY:e.clientY,
                        lastMinStep:null,
                        dayOver:this._dayOver.day,
                        to:new Date(event.to),
                        from:new Date(event.from)
                    };
                },
                onEventTrack:function(e) {
                    var minuteHeight = this.hourHeight / (60.0 / this.dragMinuteStep);
                    var minutes = Math.round((e.clientY - this._initialDragInfos.mouseY) / minuteHeight) * this.dragMinuteStep;

                    var to = new Date(this._initialDragInfos.to);
                    to.setMinutes(this._initialDragInfos.to.getMinutes() + minutes);
                    var dayDiff = this._dayOver.day - to.getDate();
                    to.setDate(to.getDate() + dayDiff);
                    var minDiff = Math.abs((to.getTime() - this._initialDragInfos.to.getTime()) / 1000 / 60);
                    if (dayDiff != 0 || ((minDiff >= this.dragMinuteStep || minDiff == 0) && this._initialDragInfos.lastMinStep != minDiff)) {
                        this._initialDragInfos.lastMinStep = minDiff;
                        var from = new Date(this._initialDragInfos.from);
                        from.setDate(from.getDate() + dayDiff);
                        from.setMinutes(from.getMinutes() + minutes);
                        this._initialDragInfos.event.dragging = {
                            from:from,
                            to:to
                        };
                        this.fire("event-changing", this._initialDragInfos.event);
                    }
                },
                onEventTrackEnd:function(e) {
                    if (this._initialDragInfos.event.dragging) {
                        var position = this._initialDragInfos.event.dragging;
                        delete this._initialDragInfos.event.dragging;
                        this.fire("event-change-committed", {
                            event:this._initialDragInfos.event,
                            newPosition: position
                        });
                    }
                    this._initialDragInfos = null;
                },
                isEventOfDay:function(event, d){
                    return this._isInDay(event.from, d) || this._isInDay(event.to, d);
                },
                _isInDay:function(date, day){
                    return date.getDate() == day.day &&
                            date.getMonth() == day.month &&
                            date.getFullYear() == day.year;
                },
                redrawAll:function(){
                    this._events.forEach(function(e){
                        e.redraw = true;
                    });
                },
                calcEventStyle:function(event){
                    if(!event.redraw) {
                        var el = this.$.agendadays.querySelector(".event[data-id='"+event.id+"']");
                        return el && el.getAttribute("style");
                    }
                    var time = new Date().getTime();

                    var from, to, opacity, zIndex, width, left;
                    if(event.dragging) {
                        from = event.dragging.from;
                        to = event.dragging.to;
                        opacity = 0.5;
                        zIndex = 1;
                        width = 100;
                        left = 0;
                    }else{
                        from = event.from;
                        to = event.to;
                        opacity = 1;
                        zIndex = 0;
                        var info = CalendarHelper.findCollisionMatrixInfoForSingleEvent(this._events, event);
                        width = 100 / info.totalColumns;
                        left = (100 / info.totalColumns) * (info.column - 1);
                    }
                    time = new Date().getTime() - time;
//                    console.log("redrawing " + JSON.stringify(event) + " -- " + time + "ms")

//                    delete event.orderEvents;
                    delete event.redraw;

                    var top = ((from.getHours() + (from.getMinutes() / 60.0)) * this.hourHeight);
                    var duration = ((to.getHours() + (to.getMinutes() / 60.0)) - (from.getHours() + (from.getMinutes() / 60.0))) * this.hourHeight;

                    return "top:" + top + "px;height:" + duration + "px;width:" + width + "%;left:" + left + "%;opacity:" + opacity + ";z-index:" + zIndex;
                },
                _onEventChanging:function(e){
                    e.detail.redraw = true;
                },
                _onEventChangeCommitted:function(e){
                    var oldGroup = CalendarHelper.findCollisionGroupsForSingleEvent(this._events, e.detail.event, true);
                    oldGroup.forEach(function (e) {
                        e.redraw = true;
                    });
                    e.detail.event.from = e.detail.newPosition.from;
                    e.detail.event.to = e.detail.newPosition.to;
                    var newGroup = CalendarHelper.findCollisionGroupsForSingleEvent(this._events, e.detail.event, true, true);
                    newGroup.forEach(function (e) {
                        e.redraw = true;
                    });
                    e.detail.event.redraw = true;
                },
                ready:function(){
                    this.addEventListener("event-changing", this._onEventChanging.bind(this));
                    this.addEventListener("event-change-committed", this._onEventChangeCommitted.bind(this));
                    var date = new Date();
                    var startDay = date.getDate() + (this.startDayOfWeek + 7) % 7;
                    var weekDays = [];
                    date.setDate(startDay);
                    this._viewFrom = new Date(date);
                    for(var i = startDay; i < startDay + 7; i++){
                        date.setDate(i);
                        weekDays.push({
                            name:Intl.DateTimeFormat(this.locale, {weekday:'narrow'}).format(date),
                            day:i,
                            month:date.getMonth(),
                            year:date.getFullYear(),
                            redraw:false
                        });
                        this._viewTo = new Date(date);
                    }
                    this._weekDays = weekDays;

                    // TEST DATA
                    var id=0;
                    var events = [
                        {
                            id:id++,
                            from:new Date("2015-04-15T09:00:00.000-0500"),
                            to:new Date("2015-04-15T12:30:00.000-0500")
                        },
                        {
                            id:id++,
                            from:new Date("2015-04-15T09:00:00.000-0500"),
                            to:new Date("2015-04-15T10:00:00.000-0500")
                        },
                        {
                            id:id++,
                            from:new Date("2015-04-15T10:00:00.000-0500"),
                            to:new Date("2015-04-15T11:30:00.000-0500")
                        },
                        {
                            id:id++,
                            from:new Date("2015-04-15T11:30:00.000-0500"),
                            to:new Date("2015-04-15T12:30:00.000-0500")
                        },
                        {
                            id:id++,
                            from:new Date("2015-04-15T09:30:00.000-0500"),
                            to:new Date("2015-04-15T14:30:00.000-0500")
                        },
                        {
                            id:id++,
                            from:new Date("2015-04-15T10:30:00.000-0500"),
                            to:new Date("2015-04-15T12:30:00.000-0500")
                        },
                        {
                            id:id++,
                            from:new Date("2015-04-15T11:00:00.000-0500"),
                            to:new Date("2015-04-15T13:30:00.000-0500")
                        },
                        {
                            id:id++,
                            from:new Date("2015-04-15T12:30:00.000-0500"),
                            to:new Date("2015-04-15T14:00:00.000-0500")
                        },
                        {
                            id:id++,
                            from:new Date("2015-04-15T14:00:00.000-0500"),
                            to:new Date("2015-04-15T17:00:00.000-0500")
                        },
                        {
                            id:id++,
                            from:new Date("2015-04-15T17:30:00.000-0500"),
                            to:new Date("2015-04-15T18:00:00.000-0500")
                        },
                        {
                            id:id++,
                            from:new Date("2015-04-16T09:00:00.000-0500"),
                            to:new Date("2015-04-16T12:30:00.000-0500")
                        },
                        {
                            id:id++,
                            from:new Date("2015-04-16T09:00:00.000-0500"),
                            to:new Date("2015-04-16T10:00:00.000-0500")
                        },
                        {
                            id:id++,
                            from:new Date("2015-04-16T10:00:00.000-0500"),
                            to:new Date("2015-04-16T11:30:00.000-0500")
                        }
                    ];

                    var startDay = 0;
                    var nEvents = 300;
                    var startDate = new Date();
                    var endDate = new Date();
                    startDate.setDate(startDate.getDate() - startDay);
                    startDate.setHours(9);
                    startDate.setMinutes(15);
                    var rdm = function(e){
                        return parseInt(Math.random() * e);
                    };
                    var lastId = events.length + 1;
                    for(var i = 0; i < nEvents; i++){
                        startDate.setMinutes(startDate.getMinutes() - (rdm(2) * 15));
                        endDate = new Date(startDate);
                        endDate.setMinutes(endDate.getMinutes() + 45 + (rdm(2) * 15));

                        var e = {
                            id:i + lastId,
                            from:new Date(startDate),
                            to:new Date(endDate),
                        };
                        events.push(e);

                        startDate = new Date(endDate);
                        if(startDate.getHours() > 19) {
                            startDate.setHours(9);
                            startDate.setMinutes((rdm(2) * 15));
                            startDate.setDate(startDate.getDate() + 1);
                        }
                    }
                    this.events = events;
                }

            });
        })();
    </script>
</polymer-element>