<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../paper-styles/paper-styles.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../iron-flex-layout/classes/iron-flex-layout.html">
<link rel="import" href="../cg-base/cg-required-validator.html">
<link rel="import" href="../cg-base/cg-validatable-behavior.html">
<link rel="import" href="../paper-material/paper-material.html">
<link rel="import" href="../cg-base/cg-base-behavior.html">

<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../paper-dialog/paper-dialog.html">
<link rel="import" href="../iron-icon/iron-icon.html">
<link rel="import" href="../iron-icons/iron-icons.html">
<link rel="import" href="../iron-pages/iron-pages.html">
<link rel="import" href="../paper-input/paper-input-container.html">
<link rel="import" href="../paper-input/paper-input-error.html">
<link rel="import" href="../paper-tabs/paper-tab.html">
<link rel="import" href="../paper-tabs/paper-tabs.html">
<link rel="import" href="../cg-datetime-picker/cg-datetime-picker-dialog.html">
<link rel="import" href="../cg-datetime-picker/cg-datetime-input.html">
<link rel="import" href="../cg-input-tags/cg-input-tags.html">
<link rel="import" href="../cg-input-color/cg-input-color.html">
<link rel="import" href="../cg-input-documents/cg-input-documents.html">
<link rel="import" href="../cg-link/cg-link.html">
<link rel="import" href="../cg-utils/cg-utils.html">

<dom-module is="cg-event-editor">
    <style>
        .editor-wrapper .colored {
            color: #4285f4;
        }
        .editor-wrapper .colored.invalid {
            color: #d34336;
        }
        .editor-wrapper .colored.invalid iron-icon {
            margin-right:5px;
        }
        .editor-wrapper .range #from {
            padding-right:20px;
        }
        .editor-wrapper #notes {
            height:135px;
        }
        .editor-wrapper #dialog {
            max-width:450px;
        }
        .editor-wrapper #dialog /deep/ #scroller {
            overflow:visible;
            max-height:none!important;
        }
        .editor-wrapper cg-input-documents {
            min-width:350px;
        }
        .editor-wrapper .event-links /deep/ .unfocused-underline {
            background-color: transparent;
        }
    </style>
    <template>
        <div class="editor-wrapper">
            <paper-dialog id="dialog" modal>
                <h2>[[heading]]</h2>
                <div on-input="_validate">
                    <paper-tabs selected="{{_selectedPage}}" noink no-slide>
                        <paper-tab>General</paper-tab>
                        <paper-tab>More</paper-tab>
                    </paper-tabs>
                    <iron-pages selected="{{_selectedPage}}">
                        <!--<div id="page_0" class="page-wrapper">-->
                        <div class$="[[ifEqualsTo(_selectedPage, 0, 'relative page-wrapper', 'page-wrapper')]]">
                            <div class="layout vertical">
                                <div hidden$="[[!hasLength(showLinks.length)]]">
                                    <paper-input-container class="event-links">
                                        <label>Links</label>
                                        <input >
                                        <div class="horizontal layout wrap">
                                            <template is="dom-repeat" items="[[links(showLink, _editCopy.links)]]" as="link">
                                                <div class="horizontal layout">
                                                    <cg-link link="[[link]]" linkSource="[[_editCopy]]" source="[[self]]"></cg-link>
                                                    <content select="[[[link]]]"></content>
                                                </div>
                                            </template>
                                        </div>
                                    </paper-input-container>
                                </div>
                                <paper-input-container auto-validate>
                                    <label>Label</label>
                                    <input is="iron-input" required bind-value="{{_editCopy.label}}">
                                    <paper-input-error>[[_validationError]]</paper-input-error>
                                </paper-input-container>
                                <div class="range layout horizontal">
                                    <paper-input-container auto-validate id="from" attr-for-value="datetime">
                                        <label>From</label>
                                        <cg-datetime-input class="paper-input-input" required datetime="{{_editCopy.from}}"></cg-datetime-input>
                                        <paper-input-error>[[_validationError]]</paper-input-error>
                                    </paper-input-container>
                                    <paper-input-container auto-validate id="to" attr-for-value="datetime">
                                        <label>To</label>
                                        <cg-datetime-input class="paper-input-input" required datetime="{{_editCopy.to}}"></cg-datetime-input>
                                        <paper-input-error>[[_validationError]]</paper-input-error>
                                    </paper-input-container>
                                </div>
                                <paper-input-container>
                                    <label>Notes</label>
                                    <textarea bind-value="{{_editCopy.notes}}" id="notes"></textarea>
                                </paper-input-container>
                            </div>
                        </div>
                        <!--<div id="page_1" class="page-wrapper">-->
                        <div class$="[[ifEqualsTo(_selectedPage, 1, 'relative page-wrapper', 'page-wrapper')]]">
                            <div class="layout vertical">
                                <paper-input-container auto-validate attr-for-value="selected">
                                    <label>Categories</label>
                                    <cg-input-tags class="paper-input-input" cg-name="events/categories" tags="[[categories]]" selected="{{_editCopy.categories}}"></cg-input-tags>
                                </paper-input-container>
                                <paper-input-container auto-validate always-float-label attr-for-value="selected">
                                    <label>Color</label>
                                    <cg-input-color class="paper-input-input" cg-name="events/colors" colors="[[colors]]" selected="{{_editCopy.color}}"></cg-input-color>
                                </paper-input-container>
                                <cg-input-documents label="Documents" cg-name="documents/event" categories="[[documentCategories]]" documents="{{_editCopy.documents}}"
                                                    auto-upload id="documentsEditor"></cg-input-documents>
                            </div>
                        </div>
                    </iron-pages>
                </div>
                <div class="buttons">
                    <paper-button class$="[[ifTrue(isValid, 'colored custom valid', 'colored custom invalid')]]" on-tap="ok" id="okButton" autofocus>
                        <iron-icon icon="[[ifTrue(isValid, 'check', 'fa:exclamation-triangle')]]"></iron-icon>
                        <span hidden$="[[create]]">ok</span>
                        <span hidden$="[[!create]]">add</span>
                    </paper-button>
                    <paper-button class="custom" on-tap="cancel">
                        <iron-icon icon="clear"></iron-icon>
                        cancel
                    </paper-button>
                    <paper-button class="custom" on-tap="confirmDelete" hidden$="[[create]]">
                        <iron-icon icon="clear"></iron-icon>
                        delete
                    </paper-button>
                </div>
            </paper-dialog>
            <paper-dialog heading="Delete event?" with-backdrop="true" id="confirmdelete">
                <h2>Delete event?</h2>
                <div>
                    <p>Are you sure you want to delete the event "<span>[[_editCopy.label]]</span>"?</p>
                    <p>Also delete attached documents or keep them?</p>
                </div>
                <paper-button dialog-confirm class="colored" on-tap="delete" data-docs="delete">
                    <iron-icon icon="check"></iron-icon>
                    yes delete all
                </paper-button>
                <paper-button dialog-confirm class="colored" on-tap="delete" data-docs="keep" autofocus>
                    <iron-icon icon="check"></iron-icon>
                    yes, but keep documents
                </paper-button>
                <paper-button dialog-dismiss>
                    <iron-icon icon="clear"></iron-icon>
                    no
                </paper-button>
            </paper-dialog>
        </div>
    </template>
</dom-module>
<script>
    Polymer({
        is:"cg-event-editor",
        properties:{
            event:{
                type:Object,
                notify:true,
                observer:'eventChanged'
            },
            heading:String,
            showLinks:Array,
            categories:Array,
            colors:Array,
            documentCategories:Array,
            existingEvent:{
                type:String,
                value:"Edit event"
            },
            addEvent:{
                type:String,
                value:"Add event"
            },
//            closeSelector: '',
            isValid:{
                type:Boolean,
                value:false
            },
            create:{
                type:Boolean,
                value:false
            },
            cgName:{
                type:String,
                value:"event"
            },
            _callerScope:Object,
            _editCopy:Object,
            templateLinkDataObserver:{
                type:Array,
                value:[]
            },
            linkTemplates:{
                type:Array,
                value:[]
            },
            _selectedPage:Number,
            _validationError:{
                type:String,
                value:"Invalid or required"
            },
            _eventTemplate:{
                type:Object,
                value:{
                    label: null,
                    notes: null,
                    from: null,
                    to: null,
                    color: {
                        name: null,
                        mask: null,
                    },
                    categories: [],
                },
                readOnly:true
            }
        },
        behaviors:[CG.BaseBehavior],
        attached: function() {
//            this.linkTemplates = Array.prototype.slice.call(Polymer.dom(this).querySelectorAll('template[link]'));
//            this.linkTemplates.forEach(function(template){
//                if (!template.bindingDelegate) {
//                    template.bindingDelegate = this.element.syntax;
//                }
//            }.bind(this));
        },
        detached:function(){
//            this.clearLinksDataObservers();
//            this._inputs.forEach(function(input){
//                input._validityObserver && input._validityObserver.close();
//            }.bind(this));
        },
        links:function(showLink, links){
            if(!showLink) return [];
            var linksArray = [];
            for(var key in links){
                linksArray.push(links[key]);
            }
            return linksArray;
        },
        _validate:function(callback){
            this.async(function(){
                var valid = this._doValidate();
//                typeof callback === "function" && callback.call(this, true);
                typeof callback === "function" && callback.call(this, valid);
            });
        },
        _doValidate:function(){
            if(!this._editCopy) {
                return;
            }
            var valid = this.inputsAllValid();
            if(this._editCopy.from && this._editCopy.to && this._editCopy.from.getTime() >= this._editCopy.to.getTime()) {
                valid = false;
                this.$.to.invalid = true;
            }
            return this.isValid = valid;
        },
        inputsAllValid:function(){
            return Polymer.dom(this.root).querySelectorAll('paper-input-container').filter(function(e){return (e.invalid);}).length == 0;
        },
        ok:function(){
            this._validate(function(valid){
                if(!valid) return;
                if(this.isDataAware()){
                    this.fireDataRequest({
                        type:"save",
                        params:{original:this.event, save:this._editCopy},
                        success:function(response){
                            this.event = CG.Utils.Objects.clone(true, this.event, response.data);
                            this.$.documentsEditor.saveDocuments(function(responses){
                                this.closeDialog("OK");
                            }.bind(this));
                        }.bind(this),
                        failure:function(response){}.bind(this)
                    });
                }else{
                    this.event = CG.Utils.Objects.clone(true, this.event, this._editCopy);
                    this.closeDialog("OK");
                }
            });
        },
        close:function(){
            this.cancel();
        },
        cancel:function(){
            this.closeDialog("CANCEL");
        },
        confirmDelete:function(){
            this.$.confirmdelete.toggle();
        },
        delete:function(e){
            var params = {deleteDocs:e.currentTarget.dataset.docs == "delete"};
            if(this.isDataAware()){
                this.fireDataRequest({
                    type:"delete",
                    params:{original:this.event},
                    success:function(response){
                        this.event = CG.Utils.Objects.clone(true, this.event, response.data);
                        if(params.deleteDocs) {
                            this.$.documentsEditor.deleteAllDocuments(function(responses){
                                this.closeDialog("DELETE", params);
                            }.bind(this));
                        }else{
                            this.closeDialog("DELETE", params);
                        }
                    }.bind(this),
                    failure:function(response){}.bind(this)
                });
            }else {
                this.closeDialog("DELETE", params);
            }
        },
        eventChanged:function(){
            if(this.event) {
                this.$.documentsEditor.dataContext = {event : this.event};
                this._editCopy = CG.Utils.Objects.clone(true, {}, this._eventTemplate, this.event);
            }else{
                this.$.documentsEditor.dataContext && delete this.$.documentsEditor.dataContext.event;
                this._editCopy = undefined;
            }
        },
//        clearLinksDataObservers : function() {
//            this.templateLinkDataObserver.forEach(function(o){
//                o.close();
//            });
//            this.templateLinkDataObserver = [];
//        },
//        bindLinkTemplates: function() {
//            this.clearLinksDataObservers();
//            if(this._editCopy) {
//                this.linkTemplates.forEach(function(template){
//                    var model = this.templateInstance ? Object.create(this.templateInstance.model) : {};
//                    model.model = {
//                        link:this._editCopy.links[template.getAttribute("type")],
//                        event:this._editCopy
//                    };
//                    var o = new PathObserver(model.model, "link");
//                    o.open(function(){
//                        this._editCopy.links[template.getAttribute("type")] = model.model.link;
//                    }.bind(this));
//                    this.templateLinkDataObserver.push(o);
//                    template.model = model;
//                    template.setAttribute('if', '{{true}}');
//                }.bind(this));
//            }
//        },
//        _editCopyChanged:function(){
//            this.bindLinkTemplates();
//        },
        augmentEvent:function(event, create){
            return event;
        },
        openDialog:function(event, edit, closeCallbackOrCallerScope){
            if(typeof closeCallbackOrCallerScope == "function") {
                this.listenOnce('close', closeCallbackOrCallerScope);
            }else{
                this._callerScope = closeCallbackOrCallerScope;
            }
            if(typeof event == "object" || !event){
                this._doOpenDialog(event, edit);
            }else{
                this.fireDataRequest({
                    type:"data",
                    params:{
                        event:event
                    },
                    success:function(response){
                        this._doOpenDialog(response.data, edit);
                    }.bind(this),
                    failure:function(response){}.bind(this)
                });
            }
        },
        _doOpenDialog:function(event,edit){
            this._selectedPage = 0;
            this.create = edit === false || event === undefined;
            this.event = this.augmentEvent ? this.augmentEvent(event || {}, this.create) : {};
            this.heading = this.create ? this.addEvent : this.existingEvent;
            this._validate(function(){
                this.$.dialog.open();
            });
        },
        closeDialog:function(result, params){
            switch(result) {
                case "OK":
                    if(this.create) {
                        this.fireApplicationEvent("event-created", this.event, this._callerScope);
                    }else{
                        this.fireApplicationEvent("event-updated", this.event, this._callerScope);
                    }
                    break;
                case "DELETE":
                    this.fireApplicationEvent("event-deleted", this.event, this._callerScope);
                    if(params.deleteDocs === true && this.event.documents) {
                        this.event.documents.forEach(function(doc){
                            this.fireApplicationEvent("document-deleted", doc, this._callerScope);
                        }.bind(this));
                    }
                    break;
            }
            this.$.documentsEditor.dataContext && delete this.$.documentsEditor.dataContext.event;
            this.$.dialog.close();
            this.fire("close", {
                event: this.event,
                result: result
            });
            this.event = undefined;

        }
    });
</script>