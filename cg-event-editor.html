<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../paper-styles/paper-styles.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../iron-flex-layout/classes/iron-flex-layout.html">
<link rel="import" href="../cg-base/cg-required-validator.html">
<link rel="import" href="../cg-base/cg-validatable-behavior.html">
<link rel="import" href="../paper-material/paper-material.html">
<link rel="import" href="../cg-base/cg-base-behavior.html">

<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../paper-dialog/paper-dialog.html">
<link rel="import" href="../iron-icon/iron-icon.html">
<link rel="import" href="../iron-icons/iron-icons.html">
<link rel="import" href="../iron-pages/iron-pages.html">
<link rel="import" href="../paper-input/paper-input-container.html">
<link rel="import" href="../paper-input/paper-input-error.html">
<link rel="import" href="../paper-tabs/paper-tab.html">
<link rel="import" href="../paper-tabs/paper-tabs.html">
<link rel="import" href="../cg-datetime-picker/cg-datetime-picker-dialog.html">
<link rel="import" href="../cg-datetime-picker/cg-datetime-input.html">
<link rel="import" href="../cg-input-tags/cg-input-tags.html">
<link rel="import" href="../cg-input-color/cg-input-color.html">
<link rel="import" href="../cg-input-documents/cg-input-documents.html">
<link rel="import" href="../cg-link/cg-link.html">
<link rel="import" href="../cg-utils/cg-utils.html">
<link rel="import" href="../neon-animation/neon-animations.html">

<dom-module is="cg-event-editor">
    <style>
        .editor-wrapper {
            @apply(--paper-font-body1);
        }

        .editor-wrapper .colored {
            color: #4285f4;
        }
        .editor-wrapper .colored.invalid {
            color: #d34336;
        }
        .editor-wrapper .colored.invalid iron-icon {
            margin-right:5px;
        }
        .editor-wrapper .range #from {
            padding-right:20px;
        }
        .editor-wrapper #notes {
            height:135px;
        }
        .editor-wrapper #dialog {
            max-width:450px;
            overflow:visible;
        }
        .editor-wrapper cg-input-documents {
            min-width:350px;
        }
        .editor-wrapper .event-links ::content .unfocused-line {
            background-color: transparent;
        }
    </style>
    <template>
        <div class="editor-wrapper">
            <paper-dialog id="dialog" modal>
                <h2 class="dialog-heading">[[heading]]</h2>
                <div on-input="_validate" class="dialog-body">
                    <paper-tabs selected="{{_selectedPage}}" noink no-slide>
                        <paper-tab>General</paper-tab>
                        <paper-tab>More</paper-tab>
                    </paper-tabs>
                    <iron-pages selected="{{_selectedPage}}">
                        <div class$="[[ifEqualsTo(_selectedPage, 0, 'relative page-wrapper', 'page-wrapper')]]">
                            <div class="layout vertical">
                                <div hidden$="[[!isGreaterThan(_editCopy.linksArray.length, 0)]]">
                                    <paper-input-container class="event-links" always-float-label>
                                        <label>Links</label>
                                        <input hidden>
                                        <div class="horizontal layout wrap">
                                            <template is="dom-repeat" items="[[_editCopy.linksArray]]" as="link" id="sdsd">
                                                <div class="horizontal layout">
                                                    <cg-link link="[[link]]" linkSource="[[_editCopy]]" source="[[self]]"></cg-link>
                                                    <div class="content-container" linktype$="[[link.type]]"></div>
                                                </div>
                                            </template>
                                        </div>
                                    </paper-input-container>
                                </div>
                                <paper-input-container auto-validate>
                                    <label>Label</label>
                                    <input is="iron-input" required bind-value="{{_editCopy.label}}">
                                    <paper-input-error>[[_validationError]]</paper-input-error>
                                </paper-input-container>
                                <div class="range layout horizontal">
                                    <paper-input-container auto-validate id="from" attr-for-value="datetime">
                                        <label>From</label>
                                        <cg-datetime-input class="paper-input-input" required datetime="{{_editCopy.from}}"></cg-datetime-input>
                                        <paper-input-error>[[_validationError]]</paper-input-error>
                                    </paper-input-container>
                                    <paper-input-container auto-validate id="to" attr-for-value="datetime">
                                        <label>To</label>
                                        <cg-datetime-input class="paper-input-input" required datetime="{{_editCopy.to}}"></cg-datetime-input>
                                        <paper-input-error>[[_validationError]]</paper-input-error>
                                    </paper-input-container>
                                </div>
                                <paper-input-container>
                                    <label>Notes</label>
                                    <textarea is="iron-input" id="notes">{{_editCopy.notes}}</textarea>
                                </paper-input-container>
                            </div>
                        </div>
                        <div class$="[[ifEqualsTo(_selectedPage, 1, 'relative page-wrapper', 'page-wrapper')]]">
                            <div class="layout vertical">
                                <paper-input-container auto-validate attr-for-value="selected">
                                    <label>Categories</label>
                                    <cg-input-tags class="paper-input-input" cg-name="events/categories" tags="[[categories]]" selected="{{_editCopy.categories}}"></cg-input-tags>
                                </paper-input-container>
                                <paper-input-container auto-validate always-float-label attr-for-value="selected">
                                    <label>Color</label>
                                    <cg-input-color class="paper-input-input" cg-name="events/colors" colors="[[colors]]" selected="{{_editCopy.color}}"></cg-input-color>
                                </paper-input-container>
                                <cg-input-documents label="Documents" cg-name="documents/event" categories="[[documentCategories]]"
                                                    auto-upload id="documentsEditor"></cg-input-documents>
                            </div>
                        </div>
                    </iron-pages>
                </div>
                <div class="buttons">
                    <paper-button class="custom" on-tap="cancel">
                        <iron-icon icon="clear"></iron-icon>
                        cancel
                    </paper-button>
                    <paper-button class="custom" on-tap="confirmDelete" hidden$="[[create]]">
                        <iron-icon icon="clear"></iron-icon>
                        delete
                    </paper-button>
                    <paper-button class$="[[ifTrue(isValid, 'colored custom valid', 'colored custom invalid')]]" on-tap="ok" id="okButton" autofocus>
                        <iron-icon icon="[[ifTrue(isValid, 'check', 'fa:exclamation-triangle')]]"></iron-icon>
                        <span hidden$="[[create]]">ok</span>
                        <span hidden$="[[!create]]">add</span>
                    </paper-button>
                </div>
            </paper-dialog>
            <paper-dialog heading="Delete event?" with-backdrop="true" id="confirmdelete">
                <h2>Delete event?</h2>
                <div>
                    <p>Are you sure you want to delete the event "<span>[[_editCopy.label]]</span>"?</p>
                    <p>Also delete attached documents or keep them?</p>
                </div>
                <paper-button dialog-confirm class="colored" on-tap="delete" data-docs="delete">
                    <iron-icon icon="check"></iron-icon>
                    yes delete all
                </paper-button>
                <paper-button dialog-confirm class="colored" on-tap="delete" data-docs="keep" autofocus>
                    <iron-icon icon="check"></iron-icon>
                    yes, but keep documents
                </paper-button>
                <paper-button dialog-dismiss>
                    <iron-icon icon="clear"></iron-icon>
                    no
                </paper-button>
            </paper-dialog>
            <content select="template[link]"></content>
        </div>
    </template>
</dom-module>
<script>
    Polymer({
        is:"cg-event-editor",
        properties:{
            listensTo:{
                value:[]
            },
            event:{
                type:Object,
                notify:true,
                observer:'eventChanged'
            },
            heading:String,
            categories:Array,
            colors:Array,
            documentCategories:Array,
            existingEvent:{
                type:String,
                value:"Edit event"
            },
            addEvent:{
                type:String,
                value:"Add event"
            },
            isValid:{
                type:Boolean,
                value:false
            },
            create:{
                type:Boolean,
                value:false
            },
            cgName:{
                type:String,
                value:"event"
            },
            _callerScope:Object,
            _editCopy:{
                type:Object,
                observer:'_editCopyChanged'
            },
            linkTemplates:{
                type:Array,
                value:[]
            },
            _selectedPage:Number,
            _validationError:{
                type:String,
                value:"Invalid or required"
            },
        },
        behaviors:[CG.BaseBehavior],
        attached: function() {
            this._inputs = Polymer.dom(this.root).querySelectorAll('paper-input-container');
            this.linkTemplates = Array.prototype.slice.call(Polymer.dom(this).querySelectorAll('template[link]'));
        },
        links:function(links){
            if(!links) return [];
            var linksArray = [];
            for(var key in links){
                linksArray.push(links[key]);
            }
            return linksArray;
        },
        _validate:function(callback){
            this.async(function(){
                var valid = this._doValidate();
                typeof callback === "function" && callback.call(this, valid);
            });
        },
        _doValidate:function(){
            if(!this._editCopy) {
                return;
            }
            var valid = this.inputsAllValid();
            if(this._editCopy.from && this._editCopy.to && this._editCopy.from.getTime() >= this._editCopy.to.getTime()) {
                valid = false;
                this.$.to.invalid = true;
            }
            return this.isValid = valid;
        },
        inputsAllValid:function(){
            for(var i = 0; i < this._inputs.length; i++){
                if(this._inputs[i].invalid) {
                    return false;
                }
            }
            return true;
        },
        ok:function(){
            this._validate(function(valid){
                if(!valid) return;
                if(this.isDataAware()){
                    this.fireDataRequest({
                        type:"save",
                        params:{original:this.event, save:this._editCopy},
                        success:function(response){
                            this.event = CG.Utils.Objects.clone(true, this.event, response.data);
                            this.$.documentsEditor.saveDocuments(function(responses){
                                this.closeDialog("OK");
                            }.bind(this));
                        }.bind(this),
                        failure:function(response){}.bind(this)
                    });
                }else{
                    this.event = CG.Utils.Objects.clone(true, this.event, this._editCopy);
                    this.closeDialog("OK");
                }
            });
        },
        close:function(){
            this.cancel();
        },
        cancel:function(){
            this.closeDialog("CANCEL");
        },
        confirmDelete:function(){
            this.$.confirmdelete.toggle();
        },
        delete:function(e){
            var params = {deleteDocs:e.currentTarget.dataset.docs == "delete"};
            if(this.isDataAware()){
                this.fireDataRequest({
                    type:"delete",
                    params:{original:this.event},
                    success:function(response){
                        this.event = CG.Utils.Objects.clone(true, this.event, response.data);
                        if(params.deleteDocs) {
                            this.$.documentsEditor.deleteAllDocuments(function(responses){
                                this.closeDialog("DELETE", params);
                            }.bind(this));
                        }else{
                            this.closeDialog("DELETE", params);
                        }
                    }.bind(this),
                    failure:function(response){}.bind(this)
                });
            }else {
                this.closeDialog("DELETE", params);
            }
        },
        eventChanged:function(){
            if(this.event) {
                this.$.documentsEditor.dataContext = {event : this.event};
                var editCopy = CG.Utils.Objects.clone(true, {}, this.event);
                editCopy.categories = editCopy.categories || [];
                editCopy.linksArray = this.links(editCopy.links);
                this._editCopy = editCopy;
            }else{
                this.$.documentsEditor.dataContext && delete this.$.documentsEditor.dataContext.event;
                this._editCopy = undefined;
            }
        },
        bindLinkTemplates: function() {
            if(this._editCopy) {
                this.doWhenConditionIsMet(function(){ // todo kind of dodgy isn't ?
                    this.linkTemplates.forEach(function(template){
                        var type = template.getAttribute("of");
                        var link = this._editCopy.links[type];
                        var event = this._editCopy;
                        if(!template.__cgInstance) {
                            var parent = Polymer.dom(this.root).querySelector("[linktype=" + link.type + "]");
                            template._parentProps = {};
                            var tmpInstance = template.stamp({
                                link:link,
                                event:event,
                            });
                            parent.appendChild(tmpInstance.root);
                            parent.addEventListener("input", function (e) {
                                this._editCopy.links[type] = e.detail;
                                this.set("_editCopy.linksArray", this.links(this._editCopy.links))
                            }.bind(this));
                            template.__cgInstance = tmpInstance;
                        }else{
                            template.__cgInstance.event = event;
                            template.__cgInstance.link = link;
                        }
                    }.bind(this));
                }, function(){
                    return Polymer.dom(this.root).querySelector("[linktype]") != undefined
                })
            }
        },
        _editCopyChanged:function(){
            this.bindLinkTemplates();
        },
        augmentEvent:function(event, create){
            return event;
        },
        openDialog:function(event, edit, closeCallbackOrCallerScope){
            if(typeof closeCallbackOrCallerScope == "function") {
                this.listenOnce('close', closeCallbackOrCallerScope);
            }else{
                this._callerScope = closeCallbackOrCallerScope;
            }
            if(typeof event == "object" || !event){
                this._doOpenDialog(event, edit);
            }else{
                this.fireDataRequest({
                    type:"data",
                    params:{
                        event:event
                    },
                    success:function(response){
                        this._doOpenDialog(response.data, edit);
                    }.bind(this),
                    failure:function(response){}.bind(this)
                });
            }
        },
        _doOpenDialog:function(event,edit){
            this._selectedPage = 0;
            this.create = edit === false || event === undefined;
            this.event = this.augmentEvent ? this.augmentEvent(event || {}, this.create) : {};
            this.heading = this.create ? this.addEvent : this.existingEvent;
            this._validate(function(){
                this.$.dialog.open();
            });
        },
        closeDialog:function(result, params){
            switch(result) {
                case "OK":
                    if(this.create) {
                        this.fireApplicationEvent("event-created", this.event, this._callerScope);
                    }else{
                        this.fireApplicationEvent("event-updated", this.event, this._callerScope);
                    }
                    break;
                case "DELETE":
                    this.fireApplicationEvent("event-deleted", this.event, this._callerScope);
                    if(params.deleteDocs === true && this.event.documents) {
                        this.event.documents.forEach(function(doc){
                            this.fireApplicationEvent("document-deleted", doc, this._callerScope);
                        }.bind(this));
                    }
                    break;
            }
            this.$.documentsEditor.dataContext && delete this.$.documentsEditor.dataContext.event;
            this.$.dialog.close();
            this.fire("close", {
                event: this.event,
                result: result
            });
            this.event = undefined;

        }
    });
</script>