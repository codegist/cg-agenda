<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../paper-input/paper-input-decorator.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../paper-dialog/paper-action-dialog.html">
<link rel="import" href="../core-icon/core-icon.html">
<link rel="import" href="../core-pages/core-pages.html">
<link rel="import" href="../paper-tabs/paper-tab.html">
<link rel="import" href="../paper-tabs/paper-tabs.html">
<link rel="import" href="../cg-datetime-picker/cg-datetime-input.html">
<link rel="import" href="../cg-input-tags/cg-input-tags.html">
<link rel="import" href="../cg-input-color/cg-input-color.html">
<link rel="import" href="../cg-input-documents/cg-input-documents.html">
<link rel="import" href="../cg-base/cg-base.html">

<polymer-element name="cg-event-editor" extends="cg-base" attributes="event eventId categories colors dataTagPrefix uploadUrl">
    <template>
        <style>
            :host {
                display:block;
            }
            :host .colored {
                color: #4285f4;
            }
            :host .range #from {
                padding-right:20px;
            }
            :host #notes {
                height:135px;
            }
            :host #dialog {
                max-width:450px;
            }
            :host #dialog /deep/ #scroller {
                overflow:visible;
                max-height:none!important;
            }
            :host cg-input-documents {
                min-width:350px;
            }
        </style>
        <paper-action-dialog heading="{{heading}}" layered="false" autoCloseDisabled id="dialog">
            <div>
                <paper-tabs selected="{{_selectedPage}}" noink noslide>
                    <paper-tab>General</paper-tab>
                    <paper-tab>More</paper-tab>
                </paper-tabs>
                <core-pages selected="{{_selectedPage}}">
                    <div class="page-wrapper">
                        <div layout vertical>
                            <paper-input-decorator label="Label" floatingLabel error="{{_validationError}}" autoValidate>
                                <input is="core-input" required value="{{_editCopy.label}}">
                            </paper-input-decorator>
                            <div class="range" layout horizontal>
                                <paper-input-decorator label="From" floatingLabel error="{{_validationError}}" autoValidate id="from">
                                    <cg-datetime-input required datetime="{{_editCopy.from}}"></cg-datetime-input>
                                </paper-input-decorator>
                                <paper-input-decorator label="To" floatingLabel error="{{_validationError}}" autoValidate id="to">
                                    <cg-datetime-input required datetime="{{_editCopy.to}}"></cg-datetime-input>
                                </paper-input-decorator>
                            </div>
                            <paper-input-decorator label="Notes" floatingLabel>
                                <textarea value="{{_editCopy.notes}}" id="notes" on-keypress="{{_validate}}"></textarea>
                            </paper-input-decorator>
                        </div>
                    </div>
                    <div class="page-wrapper" relative>
                        <div layout vertical>
                            <template if="{{categories.length > 0 || dataTagPrefix}}">
                                <paper-input-decorator label="Categories" floatingLabel error="{{_validationError}}" autoValidate>
                                    <cg-input-tags dataTagPrefix="{{(dataTagPrefix ? dataTagPrefix + '-' : '') + 'event-editor'}}" tags="{{categories}}" selected="{{_editCopy.categories}}"></cg-input-tags>
                                </paper-input-decorator>
                            </template>
                            <template if="{{colors.length > 0 || dataTagPrefix}}">
                                <paper-input-decorator label="Color" floatingLabel error="{{_validationError}}" autoValidate>
                                    <cg-input-color dataTagPrefix="{{(dataTagPrefix ? dataTagPrefix + '-' : '') + 'event-editor'}}" required colors="{{colors}}" selected="{{_editCopy.color}}"></cg-input-color>
                                </paper-input-decorator>
                            </template>
                            <cg-input-documents label="Documents" documents="{{_editCopy.documents}}" dataTagPrefix="{{(dataTagPrefix ? dataTagPrefix + '-' : '') + 'event-editor'}}"
                                                uploadUrl="{{uploadUrl}}" dataBaseParams="{{_documentInputParams}}" autoUpload="true" autoSave="false" id="documentsEditor"></cg-input-documents>
                        </div>
                    </div>
                </core-pages>
            </div>
            <paper-button affirmative class="colored custom" on-tap="{{ok}}" id="okButton">
                <core-icon affirmative icon="check"></core-icon>
                <template if="{{ !create }}">ok</template>
                <template if="{{ create }}">add</template>
            </paper-button>
            <paper-button dismissive class="custom" on-tap="{{cancel}}">
                <core-icon dismissive icon="clear"></core-icon>
                cancel
            </paper-button>
            <template if="{{ !create }}">
                <paper-button dismissive class="custom" on-tap="{{confirmDelete}}">
                    <core-icon dismissive icon="clear"></core-icon>
                    delete
                </paper-button>
            </template>
        </paper-action-dialog>
        <paper-action-dialog heading="Delete event?" backdrop autoCloseDisabled layered="true" id="confirmdelete">
            <section>
                <p>Are you sure you want to delete the event "{{_editCopy.label}}"?</p>
                <p>Also delete attached documents or keep them?</p>
            </section>
            <paper-button affirmative class="colored" on-tap="{{delete}}" data-docs="delete">
                <core-icon icon="check"></core-icon>
                yes delete all
            </paper-button>
            <paper-button affirmative class="colored" on-tap="{{delete}}" data-docs="keep">
                <core-icon icon="check"></core-icon>
                yes, but keep documents
            </paper-button>
            <paper-button dismissive>
                <core-icon icon="clear"></core-icon>
                no
            </paper-button>
        </paper-action-dialog>
    </template>
    <script>
        Polymer("cg-event-editor", {
            event:null,
            uploadUrl:null,
            heading:"",
            existingEvent:"Edit event",
            addEvent:"Add event",
            create:false,
            categories:null,
            colors:null,
            _documentInputParams:null,
            _selectedPage:0,
            _inputs:null,
            _editCopy:null,
            _validationError:"Invalid or required",
            domReady:function(){
                // TODO : why on-change attribute works on all input but not on cg-datetime-input where it works in other places??
                this._inputs = [].slice.call(this.shadowRoot.querySelectorAll("paper-input-decorator"));
                [].slice.call(this.shadowRoot.querySelectorAll("input,textarea,cg-input-tags")).forEach(function(e){
                    e.addEventListener("change", this._validate.bind(this));
                    e.addEventListener("keydown", this._validate.bind(this));
                    e.addEventListener("cut", this._validate.bind(this));
                    e.addEventListener("paste", this._validate.bind(this));
                    e.addEventListener("blur", this._validate.bind(this));
                    e.addEventListener("focus", this._validate.bind(this));
                }, this);
            },
            _validate:function(e, callback, delay){
                this._doValidate();
                // TODO HACK. Second slightly delayed validation
                // TODO HACK. For some reason when selecting date from button rather than typing it,
                // TODO HACK. change event comes with stale value, see cg-base-input > addEventListener('datetime-changed' and _onInputChange:
                this.job("validate", function(){
                    this._doValidate();
                    callback && callback();
                }.bind(this), delay || 300);
            },
            _doValidate:function(){
                var valid = true;
                this._inputs.forEach(function(e){
                    e.inputAction();
                    if(e.isInvalid) {
                        valid = false;
                    }
                }, this);
                var start = new Date(this._editCopy.from).getTime();
                var end = new Date(this._editCopy.to).getTime();
                if(start >= end) {
                    valid = false;
                    this.$.to.isInvalid = true;
                }
                this.$.okButton.disabled = !valid;
            },
            ok:function(){
                if(this.isDataAware()){
                    this.fireDataRequest({
                        type:"save",
                        params:{original:this.event, save:this._editCopy},
                        success:function(response){
                            this.event = Platform.mixin(this.event, response.data);
                            this.$.documentsEditor.saveDocuments();
                            this.closeDialog("OK");
                        }.bind(this),
                        failure:function(response){}.bind(this)
                    });
                }else{
                    this.event.from = new Date(this._editCopy.from);
                    this.event.to = new Date(this._editCopy.to);
                    this.event.label = this._editCopy.label;
                    this.event.notes = this._editCopy.notes;
                    this.event.color = this._editCopy.color;
                    this.event.documents = this._editCopy.documents.slice();
                    this.event.categories = this._editCopy.categories.slice();
                    this.closeDialog("OK");
                }
            },
            cancel:function(){
                this.closeDialog("CANCEL");
            },
            confirmDelete:function(){
                this.$.confirmdelete.toggle();
            },
            delete:function(e){
                var params = {deleteDocs:e.currentTarget.dataset.docs == "delete"};
                if(this.isDataAware()){
                    this.fireDataRequest({
                        type:"delete",
                        params:{original:this.event},
                        success:function(response){
                            params.deleteDocs && this.$.documentsEditor.deleteAllDocuments();
                            this.event = Platform.mixin(this.event, response.data);
                            this.closeDialog("DELETE", params);
                        }.bind(this),
                        failure:function(response){}.bind(this)
                    });
                }else {
                    this.closeDialog("DELETE", params);
                }
            },
            _editCopyChanged:function(){
//                this.$.notesDec.update(this.$.notes);
            },
            eventChanged:function(){
                this._editCopy = {
                    from:this.event.from ? this.event.from.toISOString() : "",
                    to:this.event.to ? this.event.to.toISOString() : "",
                    label:this.event.label,
                    notes:this.event.notes,
                    color:this.event.color || (this.colors && this.colors.length > 1 ? this.colors[0] : ""),
                    categories:this.event.categories?this.event.categories.slice():[],
                    documents:this.event.documents?this.event.documents.slice():[],
                };
                this._documentInputParams = { event:this.event };
            },
            openDialog:function(event, edit){
                this._selectedPage = 0;
                this.create = edit === false || event === undefined;
                this.event = event || {};
                this.heading = this.create ? this.addEvent : this.existingEvent;
                this.eventChanged();
                this._validate(null, function(){
                    this.$.dialog.toggle();
                }.bind(this), 10);
            },
            closeDialog:function(result, params){
                switch(result) {
                    case "OK":
                        if(this.create) {
                            this.fireApplicationEvent("event-created", this.event);
                        }else{
                            this.fireApplicationEvent("event-updated", this.event);
                        }
                        break;
                    case "DELETE":
                        this.fireApplicationEvent("event-deleted", this.event);
                        if(params.deleteDocs === true && this.event.documents) {
                            this.event.documents.forEach(function(doc){
                                this.fireApplicationEvent("document-deleted", doc);
                            }.bind(this));
                        }
                        break;
                }
                this.$.dialog.open = false;
                this.fire("close", {
                    event: this.event,
                    result: result
                });
                this.event = {};

            },
        });
    </script>
</polymer-element>